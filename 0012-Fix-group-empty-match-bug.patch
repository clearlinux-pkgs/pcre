From 382ca2bb4ffd423aceab05c4b1c1885cd3a48958 Mon Sep 17 00:00:00 2001
From: ph10 <ph10@2f5784b3-3f2a-0410-8824-cb99058d5e15>
Date: Tue, 9 Jun 2015 17:45:25 +0000
Subject: [PATCH 12/12] Fix group empty match bug.

git-svn-id: svn://vcs.exim.org/pcre/code/trunk@1566 2f5784b3-3f2a-0410-8824-cb99058d5e15
---
 ChangeLog            |  4 ++++
 pcre_compile.c       |  2 +-
 testdata/testinput2  |  2 ++
 testdata/testoutput2 | 18 ++++++++++++++++++
 4 files changed, 25 insertions(+), 1 deletion(-)

diff --git a/ChangeLog b/ChangeLog
index 16052d4..38e49d7 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -47,6 +47,10 @@ Version 8.38 xx-xxx-xxxx
     
 10. There was a buffer overflow if pcre_exec() was called with an ovector of 
     size 1. This bug was found by american fuzzy lop.
+    
+11. If a non-capturing group containing a conditional group that could match
+    an empty string was repeated, it was not identified as matching an empty
+    string itself. For example: /^(?:(?(1)x|)+)+$()/.
  
 
 Version 8.37 28-April-2015
diff --git a/pcre_compile.c b/pcre_compile.c
index 75e6aab..4df571b 100644
--- a/pcre_compile.c
+++ b/pcre_compile.c
@@ -2487,7 +2487,7 @@ for (code = first_significant_code(code + PRIV(OP_lengths)[*code], TRUE);
   if (c == OP_BRA  || c == OP_BRAPOS ||
       c == OP_CBRA || c == OP_CBRAPOS ||
       c == OP_ONCE || c == OP_ONCE_NC ||
-      c == OP_COND)
+      c == OP_COND || c == OP_SCOND)
     {
     BOOL empty_branch;
     if (GET(code, 1) == 0) return TRUE;    /* Hit unclosed bracket */
diff --git a/testdata/testinput2 b/testdata/testinput2
index d70f68d..904660f 100644
--- a/testdata/testinput2
+++ b/testdata/testinput2
@@ -4178,4 +4178,6 @@ backtracking verbs. --/
 //
 \O1
 
+/^(?:(?(1)x|)+)+$()/BZ
+
 /-- End of testinput2 --/
diff --git a/testdata/testoutput2 b/testdata/testoutput2
index 5013f64..54685fa 100644
--- a/testdata/testoutput2
+++ b/testdata/testoutput2
@@ -14468,4 +14468,22 @@ Failed: number is too big at offset 32
 \O1
 Matched, but too many substrings
 
+/^(?:(?(1)x|)+)+$()/BZ
+------------------------------------------------------------------
+        Bra
+        ^
+        SBra
+        SCond
+      1 Cond ref
+        x
+        Alt
+        KetRmax
+        KetRmax
+        $
+        CBra 1
+        Ket
+        Ket
+        End
+------------------------------------------------------------------
+
 /-- End of testinput2 --/
-- 
1.9.1

