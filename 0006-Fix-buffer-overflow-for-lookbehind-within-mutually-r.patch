From 9f2cf82ed9380bb4a726250833d6a0d295be8747 Mon Sep 17 00:00:00 2001
From: ph10 <ph10@2f5784b3-3f2a-0410-8824-cb99058d5e15>
Date: Tue, 19 May 2015 16:02:06 +0000
Subject: [PATCH 06/12] Fix buffer overflow for lookbehind within mutually
 recursive subroutines.

git-svn-id: svn://vcs.exim.org/pcre/code/trunk@1560 2f5784b3-3f2a-0410-8824-cb99058d5e15
---
 ChangeLog            | 5 ++++-
 pcre_compile.c       | 2 +-
 testdata/testinput2  | 3 +++
 testdata/testoutput2 | 3 +++
 4 files changed, 11 insertions(+), 2 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index cc26844..ae7e938 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -23,10 +23,13 @@ Version 8.38 xx-xxx-xxxx
     another group caused a buffer overflow. For example:
     /(?J)(?'d'(?'d'\g{d}))/. This bug was discovered by the LLVM fuzzer.
 
-30. A forward reference by name to a group whose number is the same as the
+5.  A forward reference by name to a group whose number is the same as the
     current group, for example in this pattern: /(?|(\k'Pm')|(?'Pm'))/, caused
     a buffer overflow at compile time. This bug was discovered by the LLVM
     fuzzer.
+    
+6.  A lookbehind assertion within a set of mutually recursive subpatterns could
+    provoke a buffer overflow. This bug was discovered by the LLVM fuzzer.
  
 
 Version 8.37 28-April-2015
diff --git a/pcre_compile.c b/pcre_compile.c
index 245a311..6974356 100644
--- a/pcre_compile.c
+++ b/pcre_compile.c
@@ -1799,7 +1799,7 @@ for (;;)
     case OP_ASSERTBACK:
     case OP_ASSERTBACK_NOT:
     do cc += GET(cc, 1); while (*cc == OP_ALT);
-    cc += PRIV(OP_lengths)[*cc];
+    cc += 1 + LINK_SIZE;
     break;
 
     /* Skip over things that don't match chars */
diff --git a/testdata/testinput2 b/testdata/testinput2
index 5eb4a33..99594f4 100644
--- a/testdata/testinput2
+++ b/testdata/testinput2
@@ -4168,4 +4168,7 @@ backtracking verbs. --/
 
 "(?J)(?'d'(?'d'\g{d}))"
 
+".*?\h.+.\.+\R*?\xd(?i)(?=!(?=b`b`b`\`b\xa9b!)`\a`bbbbbbbbbbbbb`bbbbbbbbbbbb*R\x85bbbbbbb\C?{((?2)(?))((
+\H){8(?<=(?1){29}\xa8bbbb\x16\xd\xc6^($(?<! )(\xa9H4){4}h}1)B))\x15')"
+
 /-- End of testinput2 --/
diff --git a/testdata/testoutput2 b/testdata/testoutput2
index 47f6dc9..abfed93 100644
--- a/testdata/testoutput2
+++ b/testdata/testoutput2
@@ -14456,4 +14456,7 @@ Failed: reference to non-existent subpattern at offset 26
 
 "(?J)(?'d'(?'d'\g{d}))"
 
+".*?\h.+.\.+\R*?\xd(?i)(?=!(?=b`b`b`\`b\xa9b!)`\a`bbbbbbbbbbbbb`bbbbbbbbbbbb*R\x85bbbbbbb\C?{((?2)(?))((
+\H){8(?<=(?1){29}\xa8bbbb\x16\xd\xc6^($(?<! )(\xa9H4){4}h}1)B))\x15')"
+
 /-- End of testinput2 --/
-- 
1.9.1

