From 2de04da37bc9ec8f3ec74378839e5bfa7283ea1c Mon Sep 17 00:00:00 2001
From: ph10 <ph10@2f5784b3-3f2a-0410-8824-cb99058d5e15>
Date: Mon, 8 Jun 2015 17:55:54 +0000
Subject: [PATCH 09/12] Add integer overflow check to (?n) code.

git-svn-id: svn://vcs.exim.org/pcre/code/trunk@1563 2f5784b3-3f2a-0410-8824-cb99058d5e15
---
 ChangeLog            | 2 ++
 pcre_compile.c       | 8 ++++++++
 testdata/testinput2  | 2 ++
 testdata/testoutput2 | 3 +++
 4 files changed, 15 insertions(+)

diff --git a/ChangeLog b/ChangeLog
index bb67b44..38d9638 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -39,6 +39,8 @@ Version 8.38 xx-xxx-xxxx
     numbers, for example: /(?J:(?|(?'R')(\k'R')|((?'R'))))/. This has been 
     fixed by always allowing for more memory, even if not needed. (A proper fix 
     is implemented in PCRE2, but it involves more refactoring.) 
+    
+8.  There was no check for integer overflow in subroutine calls such as (?123). 
  
 
 Version 8.37 28-April-2015
diff --git a/pcre_compile.c b/pcre_compile.c
index 4bec590..09b0e38 100644
--- a/pcre_compile.c
+++ b/pcre_compile.c
@@ -7353,7 +7353,15 @@ for (;; ptr++)
 
           recno = 0;
           while(IS_DIGIT(*ptr))
+            {
+            if (recno > INT_MAX / 10 - 1) /* Integer overflow */            
+              {                                                             
+              while (IS_DIGIT(*ptr)) ptr++;                                 
+              *errorcodeptr = ERR61;                                        
+              goto FAILED;                                                  
+              }
             recno = recno * 10 + *ptr++ - CHAR_0;
+            } 
 
           if (*ptr != (pcre_uchar)terminator)
             {
diff --git a/testdata/testinput2 b/testdata/testinput2
index c7301e5..1561da4 100644
--- a/testdata/testinput2
+++ b/testdata/testinput2
@@ -4173,4 +4173,6 @@ backtracking verbs. --/
 
 "(?J:(?|(?'R')(\k'R')|((?'R'))))"
 
+/(?<=|(\,\$(?73591620449005828816)\xa8.{7}){6}\x09)/
+
 /-- End of testinput2 --/
diff --git a/testdata/testoutput2 b/testdata/testoutput2
index bf52c02..6b78021 100644
--- a/testdata/testoutput2
+++ b/testdata/testoutput2
@@ -14461,4 +14461,7 @@ Failed: reference to non-existent subpattern at offset 26
 
 "(?J:(?|(?'R')(\k'R')|((?'R'))))"
 
+/(?<=|(\,\$(?73591620449005828816)\xa8.{7}){6}\x09)/
+Failed: number is too big at offset 32
+
 /-- End of testinput2 --/
-- 
1.9.1

