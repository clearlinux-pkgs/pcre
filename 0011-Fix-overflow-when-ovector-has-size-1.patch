From b5c4f0f2bef3a0dff74e4de806b8b5280bb666c0 Mon Sep 17 00:00:00 2001
From: ph10 <ph10@2f5784b3-3f2a-0410-8824-cb99058d5e15>
Date: Tue, 9 Jun 2015 16:46:52 +0000
Subject: [PATCH 11/12] Fix overflow when ovector has size 1.

git-svn-id: svn://vcs.exim.org/pcre/code/trunk@1565 2f5784b3-3f2a-0410-8824-cb99058d5e15
---
 ChangeLog            | 3 +++
 pcre_exec.c          | 3 ++-
 testdata/testinput2  | 3 +++
 testdata/testoutput2 | 4 ++++
 4 files changed, 12 insertions(+), 1 deletion(-)

diff --git a/ChangeLog b/ChangeLog
index c69236b..16052d4 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -44,6 +44,9 @@ Version 8.38 xx-xxx-xxxx
 
 9.  The table entry for \l in EBCDIC environments was incorrect, leading to its
     being treated as a literal 'l' instead of causing an error. 
+    
+10. There was a buffer overflow if pcre_exec() was called with an ovector of 
+    size 1. This bug was found by american fuzzy lop.
  
 
 Version 8.37 28-April-2015
diff --git a/pcre_exec.c b/pcre_exec.c
index c021fe1..24b23ca 100644
--- a/pcre_exec.c
+++ b/pcre_exec.c
@@ -6685,7 +6685,8 @@ if (md->offset_vector != NULL)
   register int *iend = iptr - re->top_bracket;
   if (iend < md->offset_vector + 2) iend = md->offset_vector + 2;
   while (--iptr >= iend) *iptr = -1;
-  md->offset_vector[0] = md->offset_vector[1] = -1;
+  if (offsetcount > 0) md->offset_vector[0] = -1;
+  if (offsetcount > 1) md->offset_vector[1] = -1;
   }
 
 /* Set up the first character to match, if available. The first_char value is
diff --git a/testdata/testinput2 b/testdata/testinput2
index 1561da4..d70f68d 100644
--- a/testdata/testinput2
+++ b/testdata/testinput2
@@ -4175,4 +4175,7 @@ backtracking verbs. --/
 
 /(?<=|(\,\$(?73591620449005828816)\xa8.{7}){6}\x09)/
 
+//
+\O1
+
 /-- End of testinput2 --/
diff --git a/testdata/testoutput2 b/testdata/testoutput2
index 6b78021..5013f64 100644
--- a/testdata/testoutput2
+++ b/testdata/testoutput2
@@ -14464,4 +14464,8 @@ Failed: reference to non-existent subpattern at offset 26
 /(?<=|(\,\$(?73591620449005828816)\xa8.{7}){6}\x09)/
 Failed: number is too big at offset 32
 
+//
+\O1
+Matched, but too many substrings
+
 /-- End of testinput2 --/
-- 
1.9.1

