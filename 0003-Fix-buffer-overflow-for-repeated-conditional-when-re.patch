From 67286d4e31be9cdeef981955efbdf6ec9da53f42 Mon Sep 17 00:00:00 2001
From: ph10 <ph10@2f5784b3-3f2a-0410-8824-cb99058d5e15>
Date: Fri, 8 May 2015 16:39:40 +0000
Subject: [PATCH 03/12] Fix buffer overflow for repeated conditional when
 referencing a duplicate name.

git-svn-id: svn://vcs.exim.org/pcre/code/trunk@1557 2f5784b3-3f2a-0410-8824-cb99058d5e15
---
 ChangeLog            | 6 +++++-
 pcre_compile.c       | 2 +-
 testdata/testinput2  | 6 ++++++
 testdata/testoutput2 | 6 ++++++
 4 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index dd6a09c..1d8b4a2 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -14,7 +14,11 @@ Version 8.38 xx-xxx-xxxx
     incorrect code to be compiled when recursive forward references were
     involved. For example, in this pattern: /(?1)()((((((\1++))\x85)+)|))/.
     This bug was discovered by the LLVM fuzzer.
-
+    
+3.  A repeated conditional group whose condition was a reference by name caused
+    a buffer overflow if there was more than one group with the given name.
+    This bug was discovered by the LLVM fuzzer.
+ 
 
 Version 8.37 28-April-2015
 --------------------------
diff --git a/pcre_compile.c b/pcre_compile.c
index ae235eb..164584b 100644
--- a/pcre_compile.c
+++ b/pcre_compile.c
@@ -6773,7 +6773,7 @@ for (;; ptr++)
             ptr++;
             }
           namelen = (int)(ptr - name);
-          if (lengthptr != NULL) *lengthptr += IMM2_SIZE;
+          if (lengthptr != NULL) skipbytes += IMM2_SIZE;
           }
 
         /* Check the terminator */
diff --git a/testdata/testinput2 b/testdata/testinput2
index 1785b17..b7cec5a 100644
--- a/testdata/testinput2
+++ b/testdata/testinput2
@@ -4160,4 +4160,10 @@ backtracking verbs. --/
 
 /\V\x85\9*+((?2)\3++()2)*:2/
 
+/(((?(R)){0,2}) (?''((?'R')((?'R')))))/J
+
+/(((?(X)){0,2}) (?''((?'X')((?'X')))))/J
+
+/(((?(R)){0,2}) (?''((?'X')((?'R')))))/
+
 /-- End of testinput2 --/
diff --git a/testdata/testoutput2 b/testdata/testoutput2
index 821c0ce..dcc4380 100644
--- a/testdata/testoutput2
+++ b/testdata/testoutput2
@@ -14448,4 +14448,10 @@ Failed: reference to non-existent subpattern at offset 22
 /\V\x85\9*+((?2)\3++()2)*:2/
 Failed: reference to non-existent subpattern at offset 26
 
+/(((?(R)){0,2}) (?''((?'R')((?'R')))))/J
+
+/(((?(X)){0,2}) (?''((?'X')((?'X')))))/J
+
+/(((?(R)){0,2}) (?''((?'X')((?'R')))))/
+
 /-- End of testinput2 --/
-- 
1.9.1

